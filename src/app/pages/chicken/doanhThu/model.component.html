<nb-card>
  <nb-card-header>
    TỔNG HỢP DOANH THU THEO ĐỊA ĐIỂM / KHÁCH HÀNG  ** <span class="doanhthu-label">{{ doantThuLabel }}</span> **
  </nb-card-header>
  <nb-card-body class="list-order cong-no">
    <div class="order-date-filter">
      <div class="col-md-12 col-lg-12 col-xxxl-12">
        <mat-form-field>
          <mat-label>LỌC THEO NGÀY</mat-label>
          <mat-date-range-input [rangePicker]="picker" (click)="picker.open()" disabled="true">
            <input matStartDate placeholder="Ngày Bắt Đầu" #dateRangeStart [ngModel]="startDate">
            <input matEndDate placeholder="Ngày Cuối"
                   #dateRangeEnd [ngModel]="endDate"
                   (dateChange)="filterByDate(dateRangeStart, dateRangeEnd)">
          </mat-date-range-input>
          <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-date-range-picker #picker></mat-date-range-picker>
        </mat-form-field>
        <div class="example-form-fields">
          <!--            KHÁCH HÀNG -->
          <mat-form-field class="padding-right-10">
            <mat-label>KHÁCH HÀNG</mat-label>
            <mat-select [(ngModel)]="selectKH">
              <mat-option value="" (click)="filterByCustomer(null)">Chọn KH</mat-option>
              <mat-option *ngFor="let o of customers" [value]="o.key" (click)="filterByCustomer(o)">
                {{o.name}}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <!--            TRƯỜNG-->
          <mat-form-field class="padding-right-10">
            <mat-label>ĐỊA ĐIỂM</mat-label>
            <mat-select [(ngModel)]="selectSchool">
              <mat-option value="" (click)="filterBySchool(null)">Chọn Địa Điểm</mat-option>
              <mat-option *ngFor="let o of schools" [value]="o.key" (click)="filterBySchool(o)">
                {{o.name}}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <!--            NHAN VIEN-->
          <mat-form-field class="padding-right-10">
            <mat-label>NHÂN VIÊN GIAO</mat-label>
            <mat-select [(ngModel)]="selectEmployee" disabled="true">
              <mat-option value="" (click)="filterByEmployee(null)">Chọn NV</mat-option>
              <mat-option *ngFor="let o of employees" [value]="o.key" (click)="filterByEmployee(o)">
                {{o.name}}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div class="reset-filter">
          <button class="primary mr-1" mat-flat-button (click)="getPreviousWeek(4)" [ngClass]="{'btn-current': cnTheoTuan === 4 }">4 Tuần Trước</button>
          <button class="primary mr-1" mat-flat-button (click)="getPreviousWeek(3)" [ngClass]="{'btn-current': cnTheoTuan === 3 }">3 Tuần Trước</button>
          <button class="primary mr-1" mat-flat-button (click)="getPreviousWeek(2)" [ngClass]="{'btn-current': cnTheoTuan === 2 }">2 Tuần Trước</button>
          <button class="primary mr-1" mat-flat-button (click)="getPreviousWeek(1)" [ngClass]="{'btn-current': cnTheoTuan === 1 }">Tuần Trước</button>
          <button class="primary mr-1" mat-flat-button (click)="getPreviousWeek(0)" [ngClass]="{'btn-current': cnTheoTuan === 0 }">Tuần Này</button>
          <button class="primary" mat-flat-button (click)="getPreviousWeek(-1)" [ngClass]="{'btn-current': cnTheoTuan === -1 }">Tuần Tới</button>
        </div>
<!--        <div (click)="resetFilter()" class="reset-filter">-->
<!--          <button mat-button (click)="resetFilter()">LỌC MẶC ĐỊNH</button>-->
<!--        </div>-->
      </div>
      <mat-divider></mat-divider>
      <h6 class="mt-2 mb-2"
          matTooltip="Xuất ra file excel"
          matTooltipClass="example-tooltip-uppercase">XUẤT DOANH THU THEO KHÁCH HÀNG HOẶC THEO ĐỊA ĐIỂM</h6>
      <div class="mb-3">
        <button nbButton status="primary" (click)="exportToExcelBySchoolOrCustomer()" class="d-print-none" [disabled]="!oFilter?.customer && !oFilter?.school">XUẤT EXCEL</button>
      </div>
      <div class="row total mb-3">
        <div class="text-center cn-total col-sm-12 mb-2">
          TỔNG DOANH THU: {{ ((congNo?.paid ?? 0) + (congNo?.unpaid ?? 0)) | currency : '' : '' : '1.0-0' }} VNĐ
        </div>
        <div class="clearfix"></div>
        <div class="col-sm da-thu">
            CÔNG NỢ ĐÃ THU: {{ congNo?.paid ?? 0 | currency : '' : '' : '1.0-0' }} VNĐ
        </div>
        <div class="col-sm chua-thu text-right">
          CÔNG NỢ CHƯA THU: {{ congNo?.unpaid ?? 0 | currency : '' : '' : '1.0-0' }} VNĐ
        </div>
      </div>
      <mat-divider></mat-divider>
    </div>

    <!-- Tổng hợp -->
    <div class="tong-hop d-none"
         *ngIf="orderService?.filterStartDate?.toString() !== 'Invalid Date' && orderService?.filterEndDate?.toString() !== 'Invalid Date'">
      <div class="order-master">
        <span>Tổng hợp từ ngày: </span> <b>{{ orderService.filterStartDate | date : 'dd/MM/YYYY' }}
        - {{ orderService.filterEndDate | date : 'dd/MM/YYYY' }}</b>
        <span class="text-right tong-hop-tien">{{ tongTienByOrder(tongHopOrder) }}</span>
      </div>
      <div class="order-tong-hop">
        <div class="ktable">
          <table class="table table-bordered mobile-zoom">
            <thead>
            <tr>
              <th scope="col" class="text-center align-middle" colspan="2">Sản Phẩm</th>
              <th scope="col" class="text-center align-middle">Đơn vị tính</th>
              <th scope="col" class="text-center align-middle">Số Lượng Giao</th>
              <th scope="col" class="text-center align-middle">Số Lượng Trả</th>
              <th scope="col" class="text-center align-middle text-right" *ngIf="showSellPrice">Giá bán</th>
              <th scope="col" class="text-center align-middle text-right" *ngIf="showSellPrice">Tổng</th>
            </tr>
            </thead>
            <tbody *ngFor="let item of tongHopOrder?.sItem | keyvalue; let idx = index;">
            <tr *ngFor="let sp of item.value; let spIdx = index;" class="k-no-border-top">
              <th scope="row" [attr.rowspan]="item?.value?.length" class="align-middle text-center"
                  *ngIf="spIdx === 0">
                {{ sp?.product?.category?.name }}
              </th>
              <th class=" align-middle">{{ sp?.product?.name }}</th>
              <th class="text-center align-middle">{{ sp?.product?.productType?.name }}</th>
              <th class="text-center align-middle">{{ sp?.qty }}</th>
              <th class="text-center align-middle">{{ getTotalReturnByItem(sp) }}</th>
              <th class=" align-middle text-right" *ngIf="showSellPrice">{{ sp?.price | currency : '' : '' : '1.0-0' }}</th>
              <th class=" align-middle text-right" *ngIf="showSellPrice">{{ getTotalByItem(sp) | currency : '' : '' : '1.0-0' }}</th>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="text-right">
<!--        <button nbButton (click)="truyThuCongNo()" class="d-print-none btn-indonhang mr-2" *ngIf="thuCongNo && selectSchool">Thu Công Nợ</button>-->
        <button nbButton (click)="exportCongNoTong()" class="d-print-none btn-indonhang">XUẤT RA EXCEL</button>
      </div>
    </div>
    <div class="clearfix mt-2"></div>

    <div class="clearfix mt-2"></div>
    <!--    CÔNG NỢ THEO ĐỊA ĐIỂM-->
    <h6 class="text-center cn-title clearfix">THU CÔNG NỢ THEO ĐỊA ĐIỂM</h6>
    <div class="clearfix"></div>
    <div class="cong-no clearfix">
      <mat-accordion>
        <mat-expansion-panel *ngFor="let item of orderBySchool; let index = index;"
                             [expanded]="false">
          <mat-expansion-panel-header>
            <mat-panel-title>
              {{ item[0]?.school?.name | uppercase }}
              <span *ngIf="checkThuCongNo(item)" class="cn-dathu">&nbsp;- ĐÃ THU CÔNG NỢ</span>
              <span *ngIf="!checkThuCongNo(item)" class="cn-chuathu">&nbsp;- CHƯA THU CÔNG NỢ</span>
            </mat-panel-title>
          </mat-expansion-panel-header>
          <div class="clearfix"></div>
          <button class="primary mr-1 mb-2" color="accent" mat-flat-button (click)="truyThuCongNo(item)" >THU CÔNG NỢ</button>
          <div class="clearfix"></div>
          <!-- Chi tiết theo ngày -->
          <div class="list-product" [ngClass]="{ 'kopacity': checkThuCongNo(item) }">
            <mat-card *ngFor="let order of item; index as i;">
              <div class="cong-not-date-title">
                Ngày: {{ order.date | date : 'dd/MM/YYYY' }}
                <div class="da-thu-cn" *ngIf="order?.paid">Đã Thu!</div>
              </div>
              <div class="ktable">
                <table class="table table-bordered mobile-zoom">
                  <thead>
                  <tr>
                    <th scope="col" class="text-center align-middle" colspan="2">Sản Phẩm</th>
                    <th scope="col" class="text-center align-middle">Đơn vị tính</th>
                    <th scope="col" class="text-center align-middle">Số Lượng Giao</th>
                    <th scope="col" class="text-center align-middle">Số Lượng Trả</th>
                    <th scope="col" class="text-center align-middle text-right" *ngIf="showSellPrice">Giá bán</th>
                    <th scope="col" class="text-center align-middle text-right" *ngIf="showSellPrice">Tổng</th>
                  </tr>
                  </thead>
                  <tbody *ngFor="let item of order.sItem | keyvalue; let idx = index;">
                  <tr *ngFor="let sp of item.value; let spIdx = index;" class="k-no-border-top">
                    <th scope="row" [attr.rowspan]="item?.value?.length" class="align-middle text-center"
                        *ngIf="spIdx === 0">
                      {{ sp?.product?.category?.name }}
                    </th>
                    <th class=" align-middle">{{ sp?.product?.name }}</th>
                    <th class="text-center align-middle">{{ sp?.product?.productType?.name }}</th>
                    <th class="text-center align-middle">{{ sp?.qty }}</th>
                    <th class="text-center align-middle">{{ getReturnByProductKey(order, sp?.product?.key) }}</th>
                    <th class=" align-middle text-right" *ngIf="showSellPrice">{{ sp?.price | currency : '' : '' : '1.0-0' }}</th>
                    <th class=" align-middle text-right" *ngIf="showSellPrice">{{ getTotalByItem(sp) | currency : '' : '' : '1.0-0' }}</th>
                  </tr>
                  </tbody>
                  <tbody *ngIf="order?.note?.length">
                  <th class="align-middle" colspan="7">Ghi chú: {{ order?.note }}</th>
                  </tbody>
                  <tbody>
                  <th class="align-middle text-right" colspan="7">Tổng cộng: {{tongTienByOrder(order)}}</th>
                  </tbody>
                </table>
              </div>
            </mat-card>

            <!-- Tổng hợp trong 1 order -->
            <div class="tong-hop" [ngClass]="{ 'd-none': isSameDay}">
              <mat-divider></mat-divider>
              <div class="order-master"
                   *ngIf="orderService?.filterStartDate?.toString() !== 'Invalid Date' && orderService?.filterEndDate?.toString() !== 'Invalid Date'">
                <span>Tổng hợp từ ngày: </span> <b>{{ orderService.filterStartDate | date : 'dd/MM/YYYY' }}
                - {{ orderService.filterEndDate | date : 'dd/MM/YYYY' }}</b>
              </div>
              <div class="order-tong-hop" *ngFor="let order of item; index as i;" [ngClass]="{ 'd-none': i >= 1}">
                <div class="ktable">
                  <table class="table table-bordered mobile-zoom">
                    <thead>
                    <tr>
                      <th scope="col" class="text-center align-middle" colspan="2">Sản Phẩm</th>
                      <th scope="col" class="text-center align-middle">Đơn vị tính</th>
                      <th scope="col" class="text-center align-middle">Số Lượng Giao</th>
                      <th scope="col" class="text-center align-middle">Số Lượng Trả</th>
                      <th scope="col" class="text-center align-middle text-right" *ngIf="showSellPrice">Giá bán</th>
                      <th scope="col" class="text-center align-middle text-right" *ngIf="showSellPrice">Tổng</th>
                    </tr>
                    </thead>
                    <tbody *ngFor="let item of order?.master?.sItem | keyvalue; let idx = index;">
                    <tr *ngFor="let sp of item.value; let spIdx = index;" class="k-no-border-top">
                      <th scope="row" [attr.rowspan]="item?.value?.length" class="align-middle text-center"
                          *ngIf="spIdx === 0">
                        {{ sp?.product?.category?.name }}
                      </th>
                      <th class=" align-middle">{{ sp?.product?.name }}</th>
                      <th class="text-center align-middle">{{ sp?.product?.productType?.name }}</th>
                      <th class="text-center align-middle">{{ sp?.qty }}</th>
                      <th class="text-center align-middle">{{ getTotalReturnByItem(sp) }}</th>
                      <th class=" align-middle text-right" *ngIf="showSellPrice">{{ sp?.price | currency : '' : '' : '1.0-0' }}</th>
                      <th class=" align-middle text-right" *ngIf="showSellPrice">{{ getTotalByItem(sp) | currency : '' : '' : '1.0-0' }}</th>
                    </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="row">
                <div class="col-sm">
                  <button class="primary mr-1 mb-2" color="accent" mat-flat-button (click)="truyThuCongNo(item)" [disabled]="checkThuCongNo(item)">THU CÔNG NỢ</button>
                </div>
                <div class="col-sm">
                  <div class="total text-right">
                    TỔNG: {{ tongTienByOrders(item) | currency : '' : '' : '1.0-0' }} VNĐ
                  </div>
                </div>
              </div>
            </div>
          </div>
        </mat-expansion-panel>
      </mat-accordion>
    </div>
    <!--    END CÔNG NỢ THEO ĐỊA ĐIỂM-->
    <!--    CÔNG NỢ THEO KHÁCH HÀNG-->
    <h6 class="text-center cn-title cn-kh">DOANH THU THEO KHÁCH HÀNG</h6>
    <div class="cong-no">
      <mat-accordion>
        <mat-expansion-panel *ngFor="let congNo of congNoByCustomer; let index = index;">
          <mat-expansion-panel-header [ngClass]="{ 'd-none': congNo?.masterTotal === 0 }">
            <mat-panel-title>
              Đối tác: {{ congNo?.customer?.name }}
              <span *ngIf="congNo?.paidTotal === congNo?.masterTotal" class="cn-dathu">&nbsp;- ĐÃ THU CÔNG NỢ</span>
              <span *ngIf="congNo?.unpaidTotal === congNo?.masterTotal" class="cn-chuathu">&nbsp;- CHƯA THU CÔNG NỢ</span>
              <span *ngIf="congNo?.unpaidTotal > 0 && congNo?.paidTotal > 0" class="cn-dathumotphan">&nbsp;- ĐÃ THU CÔNG NỢ MỘT PHẦN</span>
            </mat-panel-title>
          </mat-expansion-panel-header>
          <!-- Chi tiết theo ngày -->
          <div class="list-product" [ngClass]="{ 'd-none': congNo?.masterTotal === 0 }">
            <div class="time" [ngClass]="{ 'd-none': isSameDay}"
                 *ngIf="orderService?.filterStartDate?.toString() !== 'Invalid Date' && orderService?.filterEndDate?.toString() !== 'Invalid Date'">
              <span>Thời gian: </span> <b>Từ {{ orderService.filterStartDate | date : 'dd/MM/YYYY' }}
              tới {{ orderService.filterEndDate | date : 'dd/MM/YYYY' }}</b>
            </div>
            <div class="time" [ngClass]="{ 'd-none': !isSameDay}"
                 *ngIf="orderService?.filterStartDate?.toString() !== 'Invalid Date' && orderService?.filterEndDate?.toString() !== 'Invalid Date'">
              <span>Thời gian: </span> <b>ngày {{ orderService.filterStartDate | date : 'dd/MM/YYYY' }}</b>
            </div>
            <mat-card>
              <div class="ktable">
                <table class="table table-bordered mobile-zoom">
                  <thead>
                  <tr>
                    <th scope="col" class="text-center align-middle">STT</th>
                    <th scope="col" class="text-left align-middle">ĐIỂM TRƯỜNG</th>
                    <th scope="col" class="text-left align-middle">TIỀN (VNĐ)</th>
                    <th scope="col" class="text-left align-middle">GHI CHÚ</th>
                    <th scope="col" class="text-left align-middle">CÔNG NỢ</th>
                  </tr>
                  </thead>
                  <tbody>
                  <tr *ngFor="let diemTruong of congNo?.schools; index as i;" class="k-no-border-top" [ngClass]="{ 'kopacity': diemTruong?.paid }">
                    <th class="align-middle text-center">
                      {{ i + 1 }}
                    </th>
                    <th>{{ diemTruong?.school?.name }}</th>
                    <th class="text-left">{{ diemTruong?.total | currency : '' : '' : '1.0-0' }} VNĐ</th>
                    <th class="text-left">{{ congNo?.note }}</th>
                    <th class="text-left">
                      <span *ngIf="diemTruong?.paid">Đã Thu</span>
                    </th>
                  </tr>
                  </tbody>
                  <tbody>
                  <th class="align-middle total" colspan="7">
                    <div class="row">
                      <div class="col-sm">
                        <button class="primary" color="accent" mat-flat-button (click)="truyThuCongNoTheoTruong(congNo)" >THU CÔNG NỢ</button>
                      </div>
                      <div class="col-sm text-right">
                        Tổng cộng: {{ congNo?.masterTotal | currency : '' : '' : '1.0-0' }} VNĐ
                      </div>
                    </div>
                  </th>
                  </tbody>
                  <tbody>
                  <th class="align-middle total" colspan="7">
                    <div class="row">
                      <div class="col-sm da-thu">Đã Thu: {{ congNo?.paidTotal ?? 0 | currency : '' : '' : '1.0-0' }} VNĐ</div>
                      <div class="col-sm chua-thu text-right">Chưa Thu: {{ congNo?.unpaidTotal ?? 0 | currency : '' : '' : '1.0-0' }} VNĐ</div>
                    </div>
                  </th>
                  </tbody>
                </table>
              </div>
            </mat-card>
          </div>
        </mat-expansion-panel>
      </mat-accordion>
    </div>
    <!--    END CÔNG NỢ THEO KHÁCH HÀNG-->

    <div class="danh-sach-hoa-don pt-4">
      <h6>Danh sách đơn hàng</h6>
    </div>
    <angular2-smart-table [settings]="settings" [source]="source"
                     (userRowSelect)="printOrder($event)"
                     (custom)="onCustom($event)" class="d-none2 mobile-zoom">
    </angular2-smart-table>
    <div class="indonchobep d-none">
      <div class="text-right">Tổng đơn hàng: <b>{{ source?.count() }}</b></div>
    </div>
    <div class="text-right">
      <button nbButton (click)="exportCongNoTong1()" class="d-print-none btn-indonhang">XUẤT EXCEL</button>
    </div>
  </nb-card-body>
</nb-card>
